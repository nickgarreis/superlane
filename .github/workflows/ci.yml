name: CI

on:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

  performance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Performance budget check
        run: npm run perf:check

      - name: Upload performance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-budget-report
          path: |
            performance-reports/performance-budget-report.json
            performance-reports/bundle-budget-report.json
          if-no-files-found: warn

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --reporter=default --reporter=json --outputFile=security-reports/vitest-report.json

      - name: Upload Vitest report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-report
          path: security-reports/vitest-report.json
          if-no-files-found: warn

  frontend-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Frontend coverage
        run: npm run quality:frontend

      - name: Upload frontend coverage summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-summary
          path: security-reports/coverage/coverage-summary.json
          if-no-files-found: warn

  backend-coverage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Backend coverage
        run: npm run quality:backend

      - name: Upload backend coverage summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-summary
          path: security-reports/coverage-backend/coverage-summary.json
          if-no-files-found: warn

  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Security checks
        run: npm run security:check

      - name: Upload dependency audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-audit-report
          path: security-reports/dependency-audit-report.json
          if-no-files-found: warn

  ci-required:
    name: ci-required
    if: always()
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
      - build
      - performance
      - test
      - frontend-coverage
      - backend-coverage
      - security
    steps:
      - name: Verify required checks
        run: |
          echo "lint: ${{ needs.lint.result }}"
          echo "typecheck: ${{ needs.typecheck.result }}"
          echo "build: ${{ needs.build.result }}"
          echo "performance: ${{ needs.performance.result }}"
          echo "test: ${{ needs.test.result }}"
          echo "frontend-coverage: ${{ needs.frontend-coverage.result }}"
          echo "backend-coverage: ${{ needs.backend-coverage.result }}"
          echo "security: ${{ needs.security.result }}"

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.typecheck.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.performance.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.frontend-coverage.result }}" != "success" ] || \
             [ "${{ needs.backend-coverage.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ]; then
            echo "At least one required job failed."
            exit 1
          fi

          echo "All required jobs passed."
